"use strict";var gt=Object.create;var Ye=Object.defineProperty;var yt=Object.getOwnPropertyDescriptor;var Rt=Object.getOwnPropertyNames;var ht=Object.getPrototypeOf,wt=Object.prototype.hasOwnProperty;var vt=(r,e,t,i)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of Rt(e))!wt.call(r,s)&&s!==t&&Ye(r,s,{get:()=>e[s],enumerable:!(i=yt(e,s))||i.enumerable});return r};var We=(r,e,t)=>(t=r!=null?gt(ht(r)):{},vt(e||!r||!r.__esModule?Ye(t,"default",{value:r,enumerable:!0}):t,r));var lt=We(require("fastify")),ft=require("zod");var N=require("zod");var G=class extends Error{constructor(){super("Credentials invalids")}};var Xe=require("@prisma/client");var Ct=require("dotenv/config"),Y=require("zod"),At=Y.z.object({NODE_ENV:Y.z.enum(["development","production","test"]).default("development"),PORT:Y.z.coerce.number().default(3333),JWT_SECRET:Y.z.string()}),Je=At.safeParse(process.env);if(Je.success===!1)throw console.error("Invalid environment variables",Je.error.format()),new Error("Invalid environment variables");var q=Je.data;var c=new Xe.PrismaClient({log:q.NODE_ENV==="development"?["query"]:[]});var b=class extends Error{constructor(){super("Author to delete does not exist.")}};var $e=require("@prisma/client/runtime/library"),v=class{async findById(e){return await c.management.findUnique({where:{id:e}})}async findAuthors(){return await c.management.findMany({where:{hierarchy:"author"}})}async findByEmail(e){return await c.management.findUnique({where:{email:e}})}async register(e){return await c.management.create({data:e})}async deleteById(e){try{return await c.management.delete({where:{id:e}})}catch(t){throw t instanceof $e.PrismaClientKnownRequestError?new b:new Error}}async changeAvatar({id:e,avatar:t}){try{return await c.management.update({where:{id:e},data:{avatar:t}}),!0}catch{return!1}}};var er=require("bcryptjs");var ne=class{constructor(e){this.managementRepository=e}async handler({email:e,password:t}){let i=await this.managementRepository.findByEmail(e);if(!i)throw new G;if(!await(0,er.compare)(t,i.password))throw new G;return{manager:i}}};function rr(){return new ne(new v)}async function tr(r,e){let t=N.z.object({email:N.z.string().email(),password:N.z.string().min(6)}),i=rr();try{let{email:s,password:o}=t.parse(r.body),{manager:n}=await i.handler({email:s,password:o}),m=await e.jwtSign({hierarchy:n.hierarchy},{sign:{sub:n.id}});return e.status(200).send({name:n.name,email:n.email,avatar:n.avatar,token:m,hierarchy:n.hierarchy})}catch(s){if(s instanceof G)return e.status(401).send({error:"InvalidCredentialsError",message:s.message});if(s instanceof N.ZodError)return e.status(400).send({error:"ValidationRequestError",message:"Required email or password parameters"})}}async function sr(r){r.post("/sessions",tr)}async function D(r,e){try{if(await r.jwtVerify(),r.user.hierarchy!=="admin")return e.status(401).send({message:"Unathorized"})}catch{return e.status(401).send({message:"Unathorized"})}}var X=require("zod");var Oe=require("crypto");var a=class extends Error{constructor(){super("Resource not found.")}};var ze=require("@prisma/client/runtime/library");var p=class extends Error{constructor(){super("You are not allowed to perform this operation.")}};var l=class{async create(e){let t=e.slug??e.title.toLowerCase().replace(/[^\w\s]/g,"").replace(/\s+/g,"-")+"-"+(0,Oe.randomUUID)().substring(0,6);return await c.articles.create({data:{...e,slug:t}})}async showAll(){return await c.articles.findMany({include:{manager:{select:{name:!0}},category:{select:{category:!0}}}})}async showAllForClients(){return await c.articles.findMany({where:{state:"active"},include:{manager:{select:{name:!0,avatar:!0}},category:{select:{category:!0}},credits:{select:{name:!0,link:!0}},articleTags:{select:{tag:{select:{tag:!0}}}}}})}async showAllByManagerId(e){return await c.articles.findMany({where:{manager_id:e}})}async delete({article_id:e}){try{return await c.articles.delete({where:{id:e}})}catch(t){throw t instanceof ze.PrismaClientKnownRequestError?new a:new p}}async deleteByAdmin({article_id:e}){try{return await c.articles.delete({where:{id:e}})}catch(t){throw t instanceof ze.PrismaClientKnownRequestError?new a:new Error}}async update(e){let t=null;if(e.title&&typeof e.title=="string"){let i=e.title.toLowerCase().replace(/[^\w\s]/g,"").replace(/\s+/g,"-")+"-"+(0,Oe.randomUUID)().substring(0,6)}if(e.id&&e.manager_id)return await c.articles.update({where:{id:e.id,manager_id:e.manager_id},data:{...e,slug:t??e.slug}});throw new a}async findById(e){return await c.articles.findUnique({where:{id:e},include:{manager:{select:{name:!0}},category:{select:{category:!0}}}})}async findBySlug(e){return await c.articles.findUnique({where:{slug:e},include:{manager:{select:{name:!0,avatar:!0}},category:{select:{category:!0}},credits:{select:{name:!0,link:!0}},articleTags:{select:{tag:{select:{tag:!0}}}}}})}async findByCategory(e){return await c.articles.findMany({where:{category:{category:e}},include:{manager:{select:{name:!0,avatar:!0}},category:{select:{category:!0}},credits:{select:{name:!0,link:!0}},articleTags:{select:{tag:{select:{tag:!0}}}}}})}async findByArticleIdAndManagerId({article_id:e,manager_id:t}){return await c.articles.findUnique({where:{id:e,manager_id:t}})}};var ce=class{constructor(e){this.articlesRepository=e}async handler({article_id:e}){return(await this.articlesRepository.deleteByAdmin({article_id:e})).id===e}};function ir(){return new ce(new l)}async function or(r,e){let t=X.z.object({article_id:X.z.string()});try{let{article_id:i}=t.parse(r.body);return await ir().handler({article_id:i}),e.status(200).send({message:"success"})}catch(i){return i instanceof a?e.status(404).send({error:"ResourceNotFoundError",message:i.message}):i instanceof X.ZodError?e.status(400).send({error:"ValidationRequestError",message:"Required article id"}):e.status(500).send({error:i})}}var me=class{constructor(e){this.managementRepository=e}async handler({author_id:e}){let t=await this.managementRepository.deleteById(e);if(t)return t.id===e}};function ar(){return new me(new v)}var $=require("zod");async function nr(r,e){let t=$.z.object({author_id:$.z.string()});try{let{author_id:i}=t.parse(r.body);return await ar().handler({author_id:i}),e.status(200).send({message:"success"})}catch(i){return i instanceof b?e.status(404).send({error:"AuthorDoesntExistError",message:i.message}):i instanceof $.ZodError?e.status(400).send({error:"ValidationRequestError",message:"Required author id"}):e.status(500).send({error:i})}}var ue=class{constructor(e){this.articlesRepository=e}async handler(){let e=await this.articlesRepository.showAll();return e?e.map(t=>({id:t.id,title:t.title,subtitle:t.subtitle,text:t.text,category:t.category.category,author:t.manager?.name,created_at:t.created_at,state:t.state})):null}};function cr(){return new ue(new l)}async function mr(r,e){let t=cr();try{let i=await t.handler();return e.status(200).send({articles:i})}catch(i){return i instanceof a?e.status(404).send({error:"ResourceNotFoundError",message:i.message}):e.status(500).send({message:i})}}var le=class{constructor(e){this.managementRapository=e}async handler(){let e=await this.managementRapository.findAuthors();return e||null}};function ur(){return new le(new v)}var fe=class{constructor(e){this.articlesRepository=e}async handler({manager_id:e}){return await this.articlesRepository.showAllByManagerId(e)}};function pe(){return new fe(new l)}async function lr(r,e){let t=ur(),i=pe();try{let s=await t.handler(),o=[];if(s)for(let n of s){let m=await i.handler({manager_id:n.id});o.push({id:n.id,name:n.name,email:n.email,avatar:n.avatar,allArticles:m.length})}return e.status(200).send({authors:o})}catch(s){return s instanceof b?e.status(404).send({error:"AuthorDoesntExistError",message:s.message}):e.status(500).send({error:s})}}var fr=require("bcryptjs");var V=class extends Error{constructor(){super("E-mail already exists")}};var de=class{constructor(e){this.managementRepository=e}async handler({name:e,email:t,password:i,hierarchy:s,id:o}){let n=await(0,fr.hash)(i,6);if(await this.managementRepository.findByEmail(t))throw new V;return this.managementRepository.register({name:e,email:t,password:n,hierarchy:s,id:o})}};function pr(){return new de(new v)}var S=require("zod");async function dr(r,e){let t=S.z.object({name:S.z.string(),email:S.z.string().email(),password:S.z.string(),hierarchy:S.z.optional(S.z.string()),id:S.z.optional(S.z.string())}),i=pr();try{let{name:s,email:o,password:n,hierarchy:m,id:u}=t.parse(r.body),g=await i.handler({name:s,email:o,password:n,hierarchy:m,id:u});return e.status(200).send({name:g.name,email:g.email})}catch(s){return console.log(s),s instanceof V?e.status(400).send({error:"EmailAlreadyExistsError",message:s.message}):s instanceof S.ZodError?e.status(400).send({error:"ValidationRequestError",message:"Required mandatory parameters"}):e.status(500).send({message:s})}}var ge=class{constructor(){this.deleteArticles=or,this.deleteAuthors=nr,this.getAllArticles=mr,this.getAuthors=lr,this.registerManager=dr}};async function gr(r){let e=new ge;r.get("/get-authors",{onRequest:[D]},e.getAuthors),r.get("/get-all-articles",{onRequest:[D]},e.getAllArticles),r.post("/register",{onRequest:[D]},e.registerManager),r.delete("/delete-authors",{onRequest:[D]},e.deleteAuthors),r.delete("/delete-articles",{onRequest:[D]},e.deleteArticles)}async function A(r,e){try{if(await r.jwtVerify(),!r.user.hierarchy)throw new Error}catch{return e.status(401).send({error:"InvalidOrNotExistentTokenError",message:"Unathorized"})}}var ee=require("zod");var x=class{async create(e){return await c.categories.create({data:e})}async findCategory(e){return await c.categories.findUnique({where:{category:e}})}async findById(e){return await c.categories.findUnique({where:{id:e}})}async getAllCategories(){return await c.categories.findMany()}};var ye=class{constructor(e,t){this.ArticlesRepository=e;this.CategoriesRepository=t}async handler({id:e,title:t,subtitle:i,image:s,text:o,manager_id:n,category:m,state:u}){let g={};m&&(g=await this.CategoriesRepository.findCategory(m),g||(g=await this.CategoriesRepository.create({category:m})));let w=await this.ArticlesRepository.findByArticleIdAndManagerId({article_id:e,manager_id:n});if(!w)throw new p;return this.ArticlesRepository.update({id:e,image:s??w.image,title:t??w.title,subtitle:i??w.subtitle,text:o??w.text,state:u??w.state,category_id:g.id??w.category_id,manager_id:n})}};function B(){return new ye(new l,new x)}async function yr(r,e){let t=ee.z.object({id:ee.z.string()});console.log("chegou"),console.log(r.user.hierarchy);let{sub:i}=await r.jwtVerify(),s=B();try{let{id:o}=t.parse(r.params),n=await s.handler({id:o,state:"active",manager_id:i});return e.status(200).send({article:n})}catch(o){return o instanceof a?e.status(404).send({error:"ResourceNotFoundError",message:o.message}):o instanceof ee.ZodError?e.status(400).send({error:"ValidationRequestError",message:"Missing mandatory router parameters"}):o instanceof p?e.status(404).send({error:"ForbiddenOperationError",message:"invalid or absent parameters"}):e.status(500).send({error:o})}}var R=require("zod");var Re=class{constructor(e,t,i){this.articlesRepository=e;this.categoriesRepository=t;this.managementRepository=i}async handler(e){let t=await this.categoriesRepository.findCategory(e.category);t||(t=await this.categoriesRepository.create({category:e.category.toLowerCase()}));let i=await this.managementRepository.findById(e.manager_id);if(!i)throw new p;return this.articlesRepository.create({title:e.title,subtitle:e.subtitle,text:e.text,image:e.image,state:e.state,created_at:new Date,category_id:t.id,manager_id:i.id})}};function he(){return new Re(new l,new x,new v)}var T=class{async create(e){return await c.tags.create({data:e})}async findByName(e){return await c.tags.findFirst({where:{tag:e}})}async findById(e){return{name:(await c.tags.findUnique({where:{id:e},select:{tag:!0}}))?.tag}}};var we=class{constructor(e){this.tagsRepository=e}async handler({id:e,name:t}){let i=t.toLowerCase(),s=await this.tagsRepository.findByName(i);return s?null:(s=await this.tagsRepository.create({id:e,tag:i}),s)}};function k(){return new we(new T)}var j=class{async create(e){return await c.articlesTags.create({data:e})}async findById(e){return await c.articlesTags.findUnique({where:{id:e}})}async selectByTagsId(e){return await c.articlesTags.findMany({where:{tag_id:e}})}async selectTagsByArticleId(e){return await c.articlesTags.findMany({where:{article_id:e},select:{tag:!0}})}async selectArticlesTags(){}};var ve=class{constructor(e,t,i){this.articlesTagsRepository=e;this.articlesRepository=t;this.tagsRepository=i}async handler({id:e,article_id:t,tag_id:i}){if(!await this.articlesRepository.findById(t))throw new a;if(!await this.tagsRepository.findById(i))throw new a;if(e){let m=await this.articlesTagsRepository.findById(e);if(m)return m}return await this.articlesTagsRepository.create({article_id:t,tag_id:i})}};function _(){return new ve(new j,new l,new T)}var W=class{async create(e){return await c.credits.create({data:e})}async findCreditsByArticleId(e){return await c.credits.findMany({where:{article_id:e},select:{name:!0,link:!0}})}};var Ae=class{constructor(e,t){this.creditsRepository=e;this.articlesRepository=t}async handler({id:e,name:t,link:i,article_id:s}){if(!await this.articlesRepository.findById(s))throw new a;let n=await this.creditsRepository.findCreditsByArticleId(s);if(n){let u=n.find(g=>g.name===t&&g.link===i);if(u)return u}return await this.creditsRepository.create({id:e,name:t,link:i,article_id:s})}};function P(){return new Ae(new W,new l)}async function Rr(r,e){let t=R.z.object({article:R.z.object({title:R.z.string(),subtitle:R.z.string(),text:R.z.string(),image:R.z.string(),created_at:R.z.optional(R.z.string()),state:R.z.optional(R.z.string()),category:R.z.string()}),tags:R.z.array(R.z.object({name:R.z.string()})),credits:R.z.array(R.z.object({name:R.z.string(),link:R.z.string()}))}),{sub:i}=await r.jwtVerify(),s=he(),o=P(),n=k(),m=_();try{let{article:u,tags:g,credits:w}=t.parse(r.body),F=await s.handler({...u,manager_id:i});return w.forEach(async h=>await o.handler({article_id:F.id,name:h.name,link:h.link})),g.map(async h=>await n.handler({name:h.name})).map(async h=>{let C=await h;C&&await m.handler({tag_id:C.id,article_id:F.id})}),e.status(201).send({article:F})}catch(u){return u instanceof a?e.status(404).send({error:"ResourceNotFoundError",message:u.message}):u instanceof R.ZodError?e.status(400).send({error:"ValidationRequestError",message:"Missing mandatory router parameters"}):e.status(500).send({error:u})}}var re=require("zod");async function hr(r,e){let t=re.z.object({id:re.z.string()}),{sub:i}=await r.jwtVerify(),s=B();try{let{id:o}=t.parse(r.params),n=await s.handler({id:o,state:"inactive",manager_id:i});return e.status(200).send({article:n})}catch(o){return o instanceof a?e.status(404).send({error:"ResourceNotFoundError",message:o.message}):o instanceof re.ZodError?e.status(400).send({error:"ValidationRequestError",message:"Missing mandatory router parameters"}):o instanceof p?e.status(404).send({error:"ForbiddenOperationError",message:"invalid or absent parameters"}):e.status(500).send({error:o})}}var te=require("zod");var Fe=class{constructor(e){this.articlesRepository=e}async handler({article_id:e,manager_id:t}){let i=await this.articlesRepository.findById(e);if(!i||i.manager_id!==t)throw new p;return(await this.articlesRepository.delete({article_id:e,manager_id:t})).id===e}};function wr(){return new Fe(new l)}async function vr(r,e){let t=te.z.object({id:te.z.string()}),{sub:i}=await r.jwtVerify(),s=wr();try{let{id:o}=t.parse(r.params);return await s.handler({article_id:o,manager_id:i}),e.status(200).send({message:"success"})}catch(o){return o instanceof a?e.status(404).send({error:"ResourceNotFoundError",message:o.message}):o instanceof te.ZodError?e.status(400).send({error:"ValidationRequestError",message:"Missing mandatory router parameters"}):o instanceof p?e.status(404).send({error:"ForbiddenOperationError",message:"invalid or absent parameters"}):e.status(500).send({error:o})}}var f=require("zod");async function Ar(r,e){let t=f.z.object({article:f.z.object({title:f.z.optional(f.z.string()),subtitle:f.z.optional(f.z.string()),text:f.z.optional(f.z.string()),image:f.z.optional(f.z.string()),created_at:f.z.optional(f.z.string()),state:f.z.string(),category:f.z.string()}),tags:f.z.nullable(f.z.array(f.z.object({name:f.z.string()}))),credits:f.z.nullable(f.z.array(f.z.object({name:f.z.string(),link:f.z.string()})))}),i=f.z.object({id:f.z.string().nonempty()}),{sub:s}=await r.jwtVerify();try{let{article:o,tags:n,credits:m}=t.parse(r.body),{id:u}=i.parse(r.params),g=P(),w=k(),F=_(),h=await B().handler({...o,id:u,manager_id:s});return m&&m.forEach(async C=>await g.handler({article_id:h.id,name:C.name,link:C.link})),n&&n.map(async E=>await w.handler({name:E.name})).map(async E=>{let Q=await E;Q&&await F.handler({tag_id:Q.id,article_id:h.id})}),e.status(200).send({article:h})}catch(o){return o instanceof a?e.status(404).send({error:"ResourceNotFoundError",message:o.message}):o instanceof f.ZodError?e.status(400).send({error:"ValidationRequestError",message:"Missing mandatory router parameters"}):o instanceof p?e.status(404).send({error:"ForbiddenOperationError",message:o.message}):e.status(500).send({error:o})}}var d=require("zod");async function Fr(r,e){let t=d.z.object({article:d.z.object({title:d.z.optional(d.z.string()),subtitle:d.z.optional(d.z.string()),text:d.z.optional(d.z.string()),image:d.z.optional(d.z.string()),created_at:d.z.optional(d.z.string()),state:d.z.string(),category:d.z.string()}),tags:d.z.nullable(d.z.array(d.z.object({name:d.z.string()}))),credits:d.z.nullable(d.z.array(d.z.object({name:d.z.string(),link:d.z.string()})))}),{sub:i}=await r.jwtVerify();try{let{article:s,tags:o,credits:n}=t.parse(r.body),m=P(),u=k(),g=_(),F=await he().handler({...s,title:s.title??"",subtitle:s.subtitle??"",text:s.text??"",image:s.image??"",manager_id:i});return n&&n.forEach(async U=>await m.handler({article_id:F.id,name:U.name,link:U.link})),o&&o.map(async h=>await u.handler({name:h.name})).map(async h=>{let C=await h;C&&await g.handler({tag_id:C.id,article_id:F.id})}),e.status(201).send({article:F})}catch(s){return s instanceof a?e.status(404).send({error:"ResourceNotFoundError",message:s.message}):s instanceof d.ZodError?e.status(400).send({error:"ValidationRequestError",message:"Missing mandatory router parameters"}):s instanceof p?e.status(404).send({error:"ForbiddenOperationError",message:s.message}):e.status(500).send({error:s})}}var J=require("zod");var Se=class{constructor(e){this.articlesRepository=e}async handler({article_id:e,slug:t}){return e?await this.articlesRepository.findById(e):t?await this.articlesRepository.findBySlug(t):null}};function Sr(){return new Se(new l)}async function Cr(r,e){let t=J.z.object({id:J.z.optional(J.z.string()),slug:J.z.optional(J.z.string())}),i=Sr();try{let{id:s,slug:o}=t.parse(r.query);if(s){let n=await i.handler({article_id:s});return e.status(200).send({article:n})}else if(o){let n=await i.handler({slug:o});return e.status(200).send({article:n})}return e.status(400).send({error:"ValidationRequestError",message:"ID or Slug parameters are missing"})}catch(s){return s instanceof a?e.status(404).send({error:"ResourceNotFoundError",message:s.message}):e.status(500).send({error:s})}}var Ce=class{constructor(e){this.categoriesRepository=e}async handler({category_id:e}){let t=await this.categoriesRepository.findById(e);return t||null}};function Er(){return new Ce(new x)}async function xr(r,e){let{sub:t}=await r.jwtVerify(),i=pe(),s=Er();try{let o=await i.handler({manager_id:t}),n=[];for(let m of o){let u=await s.handler({category_id:m.category_id});n.push({...m,category:u?.category})}return e.status(200).send({articles:n})}catch(o){return o instanceof a?e.status(404).send({message:o.message}):e.status(500).send({error:o})}}var y=require("zod");async function Ir(r,e){let t=y.z.object({article:y.z.object({title:y.z.string(),subtitle:y.z.string(),text:y.z.string(),image:y.z.string(),created_at:y.z.optional(y.z.string()),state:y.z.string(),category:y.z.string()}),tags:y.z.array(y.z.object({name:y.z.string()})),credits:y.z.array(y.z.object({name:y.z.string(),link:y.z.string()}))}),i=y.z.object({id:y.z.string()}),{sub:s}=await r.jwtVerify(),o=P(),n=k(),m=_(),u=B();try{let{article:g,tags:w,credits:F}=t.parse(r.body),{id:U}=i.parse(r.params),h=await u.handler({...g,id:U,manager_id:s});return F.forEach(async E=>await o.handler({article_id:h.id,name:E.name,link:E.link})),w.map(async E=>await n.handler({name:E.name})).map(async E=>{let Q=await E;Q&&await m.handler({tag_id:Q.id,article_id:h.id})}),e.status(200).send({article:h})}catch(g){return g instanceof a?e.status(404).send({error:"ResourceNotFoundError",message:g.message}):g instanceof y.ZodError?e.status(400).send({error:"ValidationRequestError",message:"Missing mandatory router parameters"}):g instanceof p?e.status(404).send({error:"ForbiddenOperationError",message:"Article does not exist"}):e.status(500).send({error:g})}}var Ee=class{constructor(){this.create=Rr,this.delete=vr,this.update=Ir,this.get=Cr,this.active=yr,this.deactive=hr,this.drafts=Fr,this.draftsWithArticleId=Ar,this.show=xr}};async function qr(r){let e=new Ee;r.get("/",{onRequest:[A]},e.show),r.get("/get",e.get),r.post("/",{onRequest:[A]},e.create),r.put("/:id",{onRequest:[A]},e.update),r.patch("/",{onRequest:[A]},e.drafts),r.patch("/:id",{onRequest:[A]},e.draftsWithArticleId),r.patch("/deactive/:id",{onRequest:[A]},e.deactive),r.patch("/active/:id",{onRequest:[A]},e.active),r.delete("/:id",{onRequest:[A]},e.delete)}var xe=class{constructor(e){this.categoriesRepository=e}async handler(){let e=await this.categoriesRepository.getAllCategories();return e||null}};function br(){return new xe(new x)}async function Ie(r,e){let t=br();try{let i=await t.handler();return e.status(200).send({categories:i})}catch(i){return e.status(500).send({error:i})}}async function Br(r){r.get("/",Ie)}var Ze=require("@prisma/client/runtime/library");var I=class{async create(e){return await c.comments.create({data:e})}async delete({id:e,article_id:t}){try{return await c.comments.delete({where:{id:e,article_id:t}})}catch(i){throw i instanceof Ze.PrismaClientKnownRequestError?new a:new p}}async deleteByUser({id:e,user_id:t}){try{return await c.comments.delete({where:{id:e,user_id:t}})}catch(i){throw i instanceof Ze.PrismaClientKnownRequestError?new a:new p}}async findById(e){return await c.comments.findUnique({where:{id:e}})}async findByArticleId(e){try{return await c.comments.findMany({where:{article_id:e},include:{article:{select:{id:!0,title:!0,slug:!0,category:{select:{category:!0}}}},user:{select:{name:!0,email:!0}}}})}catch{return null}}};var qe=class{constructor(e,t){this.commentsRepository=e;this.articlesRepository=t}async handler({article_id:e,slug:t}){if(t&&!e){let s=await this.articlesRepository.findBySlug(t);if(!s)return null;let o=await this.commentsRepository.findByArticleId(s.id);if(o&&o.length!==0){let n={...o[0].article,category:o[0].article?.category.category},m=o.map(u=>({id:u.id,text:u.text,created_at:u.created_at,user_name:u.user.name,user_email:u.user.email}));return{article:n,comments:m}}return null}if(!e)return null;let i=await this.commentsRepository.findByArticleId(e);if(i&&i.length!==0){let s={...i[0].article,category:i[0].article?.category.category},o=i.map(n=>({id:n.id,text:n.text,created_at:n.created_at,user_name:n.user.name}));return{article:s,comments:o}}return null}};function Tr(){return new qe(new I,new l)}var O=require("zod");async function be(r,e){let t=O.z.object({article_id:O.z.optional(O.z.string()),slug:O.z.optional(O.z.string())}),i=Tr();try{let{article_id:s,slug:o}=t.parse(r.query);if(s){let n=await i.handler({article_id:s});return n?e.status(200).send(n):e.status(200).send(null)}else if(o){let n=await i.handler({slug:o});return n?e.status(200).send(n):e.status(200).send(null)}return e.status(400).send({error:"ValidationRequestError",message:"ID or Slug query parameters are missing"})}catch(s){return s instanceof a?e.status(404).send({error:"ResourceNotFoundError",message:s.message}):e.status(500).send({error:s})}}var z=require("zod");var Be=class{constructor(e){this.commentsRepository=e}async handler({comment_id:e,article_id:t}){return(await this.commentsRepository.delete({id:e,article_id:t})).id===e}};function kr(){return new Be(new I)}async function _r(r,e){let t=z.z.object({article_id:z.z.string(),comment_id:z.z.string()}),i=kr();try{let{article_id:s,comment_id:o}=t.parse(r.body);return await i.handler({article_id:s,comment_id:o})?e.status(200).send({message:"success"}):e.status(404).send({message:"not found"})}catch(s){return s instanceof a?e.status(404).send({error:"ResourceNotFoundError",message:s.message}):s instanceof z.ZodError?e.status(400).send({error:"ValidationRequestError",message:"Missing mandatory router parameters"}):s instanceof p?e.status(404).send({error:"ForbiddenOperationError",message:"Article does not exist"}):e.status(500).send({error:s})}}var Te=class{constructor(){this.managerDelete=_r,this.get=be}};async function Pr(r){let e=new Te;r.get("/from-articles",e.get),r.delete("/manager-delete",{onRequest:[A]},e.managerDelete)}var Le=require("zod");var ke=class{constructor(e){this.creditsRepository=e}async handler({article_id:e}){let t=await this.creditsRepository.findCreditsByArticleId(e);if(!t)throw new a;return t}};function Mr(){return new ke(new W)}async function Ur(r,e){let t=Le.z.object({article_id:Le.z.string()}),i=Mr();try{let{article_id:s}=t.parse(r.params),o=await i.handler({article_id:s});return o?e.status(200).send({credits:o}):e.status(404).send({error:"ResourceNotFoundError",message:"Resource not found."})}catch(s){return s instanceof a?e.status(404).send({error:"ResourceNotFoundError",message:s.message}):e.status(500).send({error:s})}}async function Gr(r){r.get("/:article_id",Ur)}var Ke=require("zod");var _e=class{constructor(e,t){this.tagsRepository=e;this.articlesTagsRepository=t}async handler({article_id:e}){let t=await this.articlesTagsRepository.selectTagsByArticleId(e);if(t){let i=[];for(let s of t){let o=await this.tagsRepository.findById(s.tag.id);i.push(o)}return i}return null}};function Nr(){return new _e(new T,new j)}async function Dr(r,e){let t=Ke.z.object({article_id:Ke.z.string()}),i=Nr();try{let{article_id:s}=t.parse(r.params),o=await i.handler({article_id:s});return o?e.status(200).send({tags:o}):e.status(404).send({error:"ResourceNotFoundError",message:"Resource not found."})}catch(s){return s instanceof a?e.status(404).send({error:"ResourceNotFoundError",message:s.message}):e.status(500).send({error:s})}}async function Vr(r){r.get("/:article_id",Dr)}var se=require("zod");var Z=class extends Error{constructor(){super("Operation not performed")}};var Pe=class{constructor(e){this.managementRepository=e}async handler({id:e,avatar:t}){let i=await this.managementRepository.changeAvatar({id:e,avatar:t});if(!i)throw new Z;return{isChanged:i}}};function jr(){return new Pe(new v)}async function Wr(r,e){let t=se.z.object({avatar:se.z.string()}),i=jr();try{let{sub:s}=await r.jwtVerify(),{avatar:o}=t.parse(r.body);return await i.handler({avatar:o,id:s}),e.status(200).send({message:"success"})}catch(s){if(s instanceof Z)return e.status(401).send({error:"OperationNotPerformedError",message:s.message});if(s instanceof se.ZodError)return e.status(400).send({error:"ValidationRequestError",message:"Required email or password parameters"})}}async function Jr(r){r.put("/avatar",{onRequest:[A]},Wr)}async function Or(r){r.register(sr),r.register(Jr,{prefix:"manager"}),r.register(gr,{prefix:"admin"}),r.register(qr,{prefix:"articles"}),r.register(Br,{prefix:"categories"}),r.register(Pr,{prefix:"comments"}),r.register(Gr,{prefix:"credits"}),r.register(Vr,{prefix:"tags"})}var M=require("zod");var L=class{async register(e){return await c.users.create({data:e})}async findById(e){return await c.users.findUnique({where:{id:e}})}async findByEmail(e){return await c.users.findUnique({where:{email:e}})}async deleteById(e){return await c.users.delete({where:{id:e}})}};var Me=class{constructor(e){this.usersRepository=e}async handler({name:e,email:t,avatar:i}){let s=await this.usersRepository.findByEmail(t);return s||await this.usersRepository.register({name:e,email:t,avatar:i??""})}};function zr(){return new Me(new L)}async function Zr(r,e){let t=M.z.object({name:M.z.string(),email:M.z.string(),avatar:M.z.optional(M.z.string())}),i=zr();try{let{name:s,avatar:o,email:n}=t.parse(r.body),m=await i.handler({name:s,avatar:o,email:n}),u=await e.jwtSign({},{sign:{sub:m.id}});return e.status(200).send({user:{name:m.name,email:m.email,avatar:m.avatar,token:u}})}catch(s){return s instanceof a?e.status(404).send({error:"ResourceNotFoundError",message:s.message}):s instanceof M.ZodError?e.status(400).send({error:"ValidationRequestError",message:"Required email or password parameters"}):e.status(500).send({err:s})}}var He=require("zod");var Ue=class{constructor(e){this.usersRepository=e}async handler({email:e}){return await this.usersRepository.findByEmail(e)}};function Lr(){return new Ue(new L)}async function Kr(r,e){let t=He.z.object({email:He.z.string()}),i=Lr();try{let{email:s}=t.parse(r.params),o=await i.handler({email:s});if(!o)return e.status(200).send(null);let n=await e.jwtSign({},{sign:{sub:o.id}});return e.status(200).send({user:{name:o.name,email:o.email,avatar:o.avatar,token:n}})}catch(s){return s instanceof a?e.status(404).send({error:"ResourceNotFoundError",message:s.message}):e.status(500).send({err:s})}}async function Hr(r){r.post("/",Zr),r.get("/:email",Kr)}var K=require("zod");var Ge=class{constructor(e,t){this.commentsRepository=e;this.articlesRepository=t}async handler({text:e,user_id:t,slug:i}){let s=await this.articlesRepository.findBySlug(i);if(!s)throw new a;return await this.commentsRepository.create({text:e,user_id:t,article_id:s.id})}};function Qr(){return new Ge(new I,new l)}async function Yr(r,e){let t=K.z.object({slug:K.z.string(),text:K.z.string()}),{slug:i,text:s}=t.parse(r.body),o=Qr(),{sub:n}=await r.jwtVerify();try{let m=await o.handler({slug:i,user_id:n,text:s});return e.status(200).send({comments:m})}catch(m){return m instanceof a?e.status(404).send({error:"ResourceNotFoundError",message:m.message}):m instanceof K.ZodError?e.status(400).send({error:"ValidationRequestError",message:"Required email or password parameters"}):e.status(500).send({err:m})}}async function Qe(r,e){try{await r.jwtVerify()}catch{return e.status(401).send({message:"Unathorized"})}}var ie=require("zod");var Ne=class{constructor(e){this.commentsRepository=e}async handler({comment_id:e,user_id:t}){return(await this.commentsRepository.deleteByUser({id:e,user_id:t})).id===e}};function Xr(){return new Ne(new I)}async function $r(r,e){let t=ie.z.object({comment_id:ie.z.string()}),{sub:i}=await r.jwtVerify(),s=Xr();try{let{comment_id:o}=t.parse(r.params);return await s.handler({comment_id:o,user_id:i})?e.status(200).send({message:"success"}):e.status(404).send({message:"not found"})}catch(o){return o instanceof a?e.status(404).send({error:"ResourceNotFoundError",message:o.message}):o instanceof ie.ZodError?e.status(400).send({error:"ValidationRequestError",message:"Required email or password parameters"}):e.status(500).send({err:o})}}async function et(r){r.post("/",{onRequest:[Qe]},Yr),r.delete("/:comment_id",{onRequest:[Qe]},$r),r.get("/from-articles",be)}var De=class{constructor(e){this.articlesRepository=e}async handler(e){let t=await this.articlesRepository.findBySlug(e);return t?{slug:t.slug,title:t.title,subtitle:t.subtitle,text:t.text,image:t.image,created_at:new Date(t.created_at).toLocaleString([],{month:"long",day:"numeric",year:"numeric"}),state:t.state,category:t.category.category,author:{name:t.manager?.name,avatar:t.manager?.avatar},credits:t.credits,tags:t.articleTags.map(i=>i.tag.tag)}:null}};function rt(){return new De(new l)}var oe=require("zod");async function tt(r,e){let t=oe.z.object({slug:oe.z.string()}),i=rt();try{let{slug:s}=t.parse(r.params),o=await i.handler(s);return e.status(200).send({articles:o})}catch(s){return s instanceof a?e.status(404).send({error:"ResourceNotFoundError",message:s.message}):s instanceof oe.ZodError?e.status(400).send({error:"ValidationRequestError",message:"Required email or password parameters"}):e.status(500).send({err:s})}}var ae=require("zod");var Ve=class{constructor(e){this.articlesRepository=e}async handler({category:e}){let t=await this.articlesRepository.findByCategory(e);if(!t)throw new a;return t.map(s=>({slug:s.slug,title:s.title,subtitle:s.subtitle,text:s.text,image:s.image,created_at:new Date(s.created_at).toLocaleString([],{month:"long",day:"numeric",year:"numeric"}),state:s.state,category:s.category.category,author:{name:s.manager?.name,avatar:s.manager?.avatar},credits:s.credits,tags:s.articleTags.map(o=>o.tag.tag)}))}};function st(){return new Ve(new l)}async function it(r,e){let t=ae.z.object({category:ae.z.string()}),i=st();try{let{category:s}=t.parse(r.body),o=await i.handler({category:s});return e.status(200).send({articles:o})}catch(s){return s instanceof a?e.status(404).send({error:"ResourceNotFoundError",message:s.message}):s instanceof ae.ZodError?e.status(400).send({error:"ValidationRequestError",message:"Required email or password parameters"}):e.status(500).send({err:s})}}var je=class{constructor(e){this.articlesRepository=e}async handler(){let e=await this.articlesRepository.showAllForClients();if(!e)throw new a;return e.map(i=>({slug:i.slug,title:i.title,subtitle:i.subtitle,text:i.text,image:i.image,created_at:new Date(i.created_at).toLocaleString([],{month:"long",day:"numeric",year:"numeric"}),state:i.state,category:i.category.category,author:{name:i.manager?.name,avatar:i.manager?.avatar},credits:i.credits,tags:i.articleTags.map(s=>s.tag.tag)}))}};function ot(){return new je(new l)}async function at(r,e){let t=ot();try{let i=await t.handler();return e.status(200).send({articles:i})}catch(i){return i instanceof a?e.status(404).send({message:i.message}):e.status(500).send({error:i})}}async function nt(r){r.get("/",at),r.get("/by/:slug",tt),r.post("/get-by-category",it)}async function ct(r){r.get("/",Ie)}async function mt(r){r.register(Hr,{prefix:"users"}),r.register(nt,{prefix:"articles"}),r.register(et,{prefix:"comments"}),r.register(ct,{prefix:"categories"})}async function ut(r){r.register(Or,{prefix:"cms"}),r.register(mt,{prefix:"client"})}var pt=We(require("@fastify/jwt"));var dt=We(require("@fastify/cors")),H=(0,lt.default)({bodyLimit:8048576});H.register(pt.default,{secret:q.JWT_SECRET});H.register(dt.default,{origin:(r,e)=>{if(r){let t=new URL(r).hostname;if(t==="localhost"){e(null,!0);return}else if(t==="artechcms.netlify.app"){e(null,!0);return}else if(t==="artechblog.netlify.app"){e(null,!0);return}}e(new Error("Not allowed"),!1)}});H.register(ut);H.setErrorHandler((r,e,t)=>r instanceof ft.ZodError?t.status(400).send({message:"Validation error",issues:r.format()}):(q.NODE_ENV!=="production"&&console.error(r),t.status(500).send({message:"Internal Server Error"})));H.listen({host:"localhost",port:q.PORT}).then(()=>{console.log("HTTP server running on PORT",q.PORT)});
